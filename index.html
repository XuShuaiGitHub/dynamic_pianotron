<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é«˜çº§è™šæ‹Ÿç”µå­é’¢ç´ - è·³åŠ¨éŸ³ç¬¦æ•ˆæœ</title>
    <style>
      :root {
        --theme-color: #ff69b4;
        --theme-gradient: linear-gradient(45deg, #ff69b4, #ff3366);
      }

      body {
        font-family: Arial, sans-serif;
        background: var(--theme-gradient);
        text-align: center;
        margin: 0;
        padding: 20px;
      }

      h1 {
        margin-bottom: 10px;
      }

      .controls {
        margin-bottom: 20px;
      }

      .controls button {
        padding: 8px 12px;
        margin: 0 5px;
        font-size: 14px;
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid var(--theme-color);
        border-radius: 20px;
        transition: all 0.3s;
      }

      .controls button:hover {
        background: var(--theme-color);
        color: white;
        transform: translateY(-2px);
      }

      .piano-container {
        position: relative;
        width: 480px;
        height: 200px;
        margin: 0 auto;
      }

      .piano {
        position: relative;
        width: 480px;
        height: 200px;
      }

      .key {
        position: absolute;
        border: 1px solid #000;
        cursor: pointer;
        user-select: none;
      }

      .white {
        width: 60px;
        height: 200px;
        background: white;
        z-index: 1;
      }

      .black {
        width: 40px;
        height: 120px;
        background: black;
        z-index: 2;
        color: #fff;
      }

      .key.active.white {
        background: linear-gradient(45deg, #fff5f5, #ffecec);
        box-shadow: inset 0 0 15px #ffb6c1;
      }
      .key.active.black {
        background: #555;
      }

      .black.active::after {
        content: "";
        position: absolute;
        top: 0;
        left: -10px;
        width: 140%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent 20%,
          rgba(255, 182, 193, 0.6) 50%,
          transparent 80%
        );
        animation: blackShine 0.4s;
      }

      @keyframes blackShine {
        from {
          left: -10px;
        }
        to {
          left: 100%;
        }
      }

      /* æµ®åŠ¨éŸ³ç¬¦æ˜¾ç¤ºåŒºåŸŸ */
      #notes-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        pointer-events: none;
        overflow: visible;
      }

      /* æµ®åŠ¨éŸ³ç¬¦æ ·å¼åŠåŠ¨ç”» */
      .floating-note {
        position: absolute;
        font-size: 24px;
        color: #ff4500;
        animation: jumpAndFade 1s ease-out forwards;
      }

      @keyframes jumpAndFade {
        0% {
          opacity: 1;
          transform: translate(-50%, 0);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -100px);
        }
      }

      .music-note-icon {
        display: inline-block;
        font-size: 32px;
        /* æ·»åŠ ä¸€ä¸ªç¼©æ”¾è·³åŠ¨æ•ˆæœ */
        animation: scaleBounce 1s ease-out forwards;
      }

      @keyframes scaleBounce {
        0% {
          transform: scale(0.5);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      .instructions {
        margin-top: 30px;
        text-align: left;
        max-width: 480px;
        margin-left: auto;
        margin-right: auto;
        background: #fff;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      #fireworks-canvas {
        position: fixed;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: -1;
        background: transparent !important;
      }
    </style>
  </head>
  <body>
    <h1>é«˜çº§è™šæ‹Ÿç”µå­é’¢ç´</h1>
    <div class="controls">
      <button id="octave-down">é™ä½å…«åº¦</button>
      <span id="current-octave">å½“å‰åŸºå‡†å…«åº¦: 4</span>
      <button id="octave-up">æé«˜å…«åº¦</button>
      <button id="transpose-down">è½¬è°ƒ -1</button>
      <button id="transpose-up">è½¬è°ƒ +1</button>
      <span id="current-transpose">å½“å‰è½¬è°ƒ: 0</span>
    </div>

    <div class="piano-container">
      <div class="piano">
        <!-- ç™½é”® -->
        <div class="key white" data-key="a" style="left: 0px">a</div>
        <div class="key white" data-key="s" style="left: 60px">s</div>
        <div class="key white" data-key="d" style="left: 120px">d</div>
        <div class="key white" data-key="f" style="left: 180px">f</div>
        <div class="key white" data-key="g" style="left: 240px">g</div>
        <div class="key white" data-key="h" style="left: 300px">h</div>
        <div class="key white" data-key="j" style="left: 360px">j</div>
        <div class="key white" data-key="k" style="left: 420px">k</div>

        <!-- é»‘é”® -->
        <div class="key black" data-key="w" style="left: 40px">w</div>
        <div class="key black" data-key="e" style="left: 100px">e</div>
        <div class="key black" data-key="t" style="left: 220px">t</div>
        <div class="key black" data-key="y" style="left: 280px">y</div>
        <div class="key black" data-key="u" style="left: 340px">u</div>
      </div>
    </div>

    <!-- æµ®åŠ¨éŸ³ç¬¦æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="notes-container"></div>

    <div class="instructions">
      <h2>é”®ç›˜æ˜ å°„ï¼ˆå½“å‰åŸºå‡†å…«åº¦å’Œè½¬è°ƒä¼šå½±å“å®é™…éŸ³é«˜ï¼‰</h2>
      <ul>
        <li>a: C</li>
        <li>w: C#</li>
        <li>s: D</li>
        <li>e: D#</li>
        <li>d: E</li>
        <li>f: F</li>
        <li>t: F#</li>
        <li>g: G</li>
        <li>y: G#</li>
        <li>h: A</li>
        <li>u: A#</li>
        <li>j: B</li>
        <li>k: Cï¼ˆé«˜äºå…¶ä»–é”®ä¸€ä¸ªå…«åº¦ï¼‰</li>
      </ul>
      <p>
        é€šè¿‡â€œæé«˜å…«åº¦/é™ä½å…«åº¦â€å’Œâ€œè½¬è°ƒâ€æŒ‰é’®ï¼Œä½ å¯ä»¥è°ƒæ•´åŸºå‡†éŸ³åŸŸã€‚æ¯æ¬¡æŒ‰é”®è§¦å‘åï¼Œè¿˜ä¼šå‡ºç°ä¸€ä¸ªè·³åŠ¨çš„éŸ³ç¬¦åŠ¨ç”»ï¼Œè®©äº¤äº’æ›´ç”ŸåŠ¨ã€‚
      </p>
      <h2>ä»¥é’¢ç´æ›²ã€Šæ¬¢ä¹é¢‚ã€‹ä¸ºä¾‹ï¼Œå…¶æ¼”å¥ä¹è°±ä¸ºï¼š</h2>
      <ul>
        <li>å°èŠ‚1ï¼ˆ3 3 4 5ï¼‰ï¼šæŒ‰é”®é¡ºåº â†’ d, d, f, g</li>
        <li>å°èŠ‚2ï¼ˆ5 4 3 2ï¼‰ï¼šæŒ‰é”®é¡ºåº â†’ g, f, d, s</li>
        <li>å°èŠ‚3ï¼ˆ1 1 2 3ï¼‰ï¼šæŒ‰é”®é¡ºåº â†’ a, a, s, d</li>
        <li>å°èŠ‚4ï¼ˆ3 2 2 -ï¼‰ï¼šæŒ‰é”®é¡ºåº â†’ d, s, s</li>
        <li>å°èŠ‚5ï¼ˆ3 3 4 5ï¼‰ï¼šæŒ‰é”®é¡ºåº â†’ d, d, f, g</li>
        <li>å°èŠ‚6ï¼ˆ5 4 3 2ï¼‰ï¼šæŒ‰é”®é¡ºåº â†’ g, f, d, s</li>
        <li>å°èŠ‚7ï¼ˆ1 1 2 3ï¼‰ï¼šæŒ‰é”®é¡ºåº â†’ a, a, s, d</li>
        <li>å°èŠ‚8ï¼ˆ2 1 1 -ï¼‰ï¼šæŒ‰é”®é¡ºåº â†’ s, a, a</li>
      </ul>
    </div>

    <!-- åœ¨bodyæœ«å°¾æ·»åŠ canvaså…ƒç´  -->
    <canvas id="fireworks-canvas"></canvas>

    <script>
      // å®šä¹‰å„è‡ªç„¶éŸ³ç›¸å¯¹äºCçš„åŠéŸ³åç§»
      const noteOffsets = {
        C: 0,
        "C#": 1,
        D: 2,
        "D#": 3,
        E: 4,
        F: 5,
        "F#": 6,
        G: 7,
        "G#": 8,
        A: 9,
        "A#": 10,
        B: 11,
      };

      // é”®ç›˜æ˜ å°„ï¼Œæ¯ä¸ªé”®æ˜ å°„åˆ°éŸ³ç¬¦å’Œç›¸å¯¹äºåŸºå‡†å…«åº¦çš„åç§»
      const keyMap = {
        a: { note: "C", octaveOffset: 0 },
        w: { note: "C#", octaveOffset: 0 },
        s: { note: "D", octaveOffset: 0 },
        e: { note: "D#", octaveOffset: 0 },
        d: { note: "E", octaveOffset: 0 },
        f: { note: "F", octaveOffset: 0 },
        t: { note: "F#", octaveOffset: 0 },
        g: { note: "G", octaveOffset: 0 },
        y: { note: "G#", octaveOffset: 0 },
        h: { note: "A", octaveOffset: 0 },
        u: { note: "A#", octaveOffset: 0 },
        j: { note: "B", octaveOffset: 0 },
        k: { note: "C", octaveOffset: 1 }, // â€œkâ€é”®ä»£è¡¨é«˜ä¸€ä¸ªå…«åº¦çš„C
      };

      let baseOctave = 4;
      let transpose = 0;

      function updateDisplay() {
        document.getElementById(
          "current-octave"
        ).textContent = `å½“å‰åŸºå‡†å…«åº¦: ${baseOctave}`;
        document.getElementById(
          "current-transpose"
        ).textContent = `å½“å‰è½¬è°ƒ: ${transpose}`;
      }

      // è®¡ç®—éŸ³ç¬¦é¢‘ç‡ï¼šf = 440 Ã— 2^((effectiveSemitone)/12)
      function getFrequency(note, octave) {
        const semitoneDiff =
          (octave - 4) * 12 +
          (noteOffsets[note] - noteOffsets["A"]) +
          transpose;
        return 440 * Math.pow(2, semitoneDiff / 12);
      }

      // æ’­æ”¾éŸ³ç¬¦
      const audioContext = new (window.AudioContext ||
        window.webkitAudioContext)();
      let oscillator;

      function playNote(note, octave) {
        oscillator?.stop();
        const freq = getFrequency(note, octave);
        oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        const safeFreq = Math.max(
          0.0001,
          Math.min(96000, Number.isFinite(freq) ? freq : 440)
        ); // å¼ºåˆ¶é™å®šæœ‰æ•ˆèŒƒå›´
        oscillator.frequency.value = Math.fround(safeFreq); // è§£å†³ç²¾åº¦é—®é¢˜
        oscillator.type = "sine";

        const now = audioContext.currentTime;
        gainNode.gain.cancelScheduledValues(now);
        // åœ¨å½“å‰æ—¶é—´ç«‹å³å°†å¢ç›Šå€¼è®¾ä¸º0ï¼Œå³éŸ³é‡ä¸º0
        gainNode.gain.setValueAtTime(0, now);
        // åœ¨0.1ç§’å†…ä½¿å¢ç›Šå€¼çº¿æ€§ä¸Šå‡åˆ°1
        gainNode.gain.linearRampToValueAtTime(1, now + 0.1);
        // now+0.5ç§’åï¼Œå°†å¢ç›Šè®¾ç½®ä¸º1
        gainNode.gain.setValueAtTime(1, now + 0.5);
        // åœ¨ now+0.45 åˆ° now+0.7 ä¹‹é—´ï¼Œä½¿å¢ç›Šå€¼çº¿æ€§ä¸‹é™åˆ°0
        gainNode.gain.linearRampToValueAtTime(0, now + 0.7);

        oscillator.start(now);
        oscillator.stop(now + 0.7);
      }

      // æ˜¾ç¤ºè·³åŠ¨éŸ³ç¬¦çš„åŠ¨ç”»æ•ˆæœ
      function showFloatingNote(note, octave, keyElement) {
        const container = document.getElementById("notes-container");
        const noteDiv = document.createElement("div");
        noteDiv.className = "floating-note";
        // noteDiv.textContent = note + octave; // å¦‚ "C4"
        noteDiv.innerHTML = '<span class="music-note-icon">ğŸˆ</span>';

        // ä»¥ç´é”®ä½ç½®ä¸ºåŸºå‡†
        const rect = keyElement.getBoundingClientRect();
        noteDiv.style.left = rect.left + rect.width / 2 + "px";
        noteDiv.style.top = rect.top - 30 + "px"; // æ˜¾ç¤ºåœ¨ç´é”®ä¸Šæ–¹30pxå¤„

        container.appendChild(noteDiv);
        // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ ï¼ˆåŠ¨ç”»æ—¶é•¿1ç§’ï¼‰
        setTimeout(() => {
          container.removeChild(noteDiv);
        }, 1000);
      }

      class Firework {
        constructor(x, hue = 200) {
          this.x = x;
          this.y = document.documentElement.clientHeight;
          this.hue = Math.random() * 50 + 280; // ç²‰è‰²ç³»
          this.targetY = Math.random() * 200 + 100;
          this.speed = 8;
          this.angle = Math.PI / 2; // å‚ç›´å‘ä¸Š
          this.radius = 2;
          this.exploded = false;
          this.particles = [];
        }

        update() {
          if (!this.exploded) {
            this.x += Math.cos(this.angle) * this.speed;
            this.y -= Math.sin(this.angle) * this.speed;

            // åˆ°è¾¾ç›®æ ‡é«˜åº¦åçˆ†ç‚¸
            if (this.y <= this.targetY) {
              this.explode();
            }
          }

          // æ›´æ–°ç²’å­
          this.particles = this.particles.filter((p) => {
            p.update();
            return p.opacity > 0.1;
          });
        }

        explode() {
          this.exploded = true;
          const particleCount = 100;
          for (let i = 0; i < particleCount; i++) {
            const angle = Math.PI * 2 * (i / particleCount);
            this.particles.push(new Particle(this.x, this.y, angle, this.hue));
          }
        }

        draw(ctx) {
          if (!this.exploded) {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.fillStyle = `hsla(${this.hue}, 100%, 50%, 1)`;
            ctx.fill();
          }

          this.particles.forEach((p) => p.draw(ctx));
        }
      }

      class Particle {
        constructor(x, y, angle, hue) {
          this.x = x;
          this.y = y;
          this.angle = angle + (Math.random() - 0.5) * 0.4; // éšæœºåç§»è§’åº¦
          this.velocity = Math.random() * 5 + 2;
          this.hue = hue + Math.random() * 20 - 10;
          this.gravity = 0.2;
          this.opacity = 1;
          this.friction = Math.random() * 0.05 + 0.95;
          this.size = Math.random() * 2 + 1;
        }

        update() {
          this.velocity *= this.friction;
          this.x += Math.cos(this.angle) * this.velocity;
          this.y += Math.sin(this.angle) * this.velocity + this.gravity;
          this.opacity -= 0.015;
        }

        draw(ctx) {
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fillStyle = `hsla(${this.hue}, 80%, 60%, ${this.opacity})`;
          ctx.fill();
        }
      }

      // çƒŸèŠ±ç³»ç»Ÿæ§åˆ¶å™¨
      class FireworksSystem {
        constructor() {
          this.canvas = document.getElementById("fireworks-canvas");
          this.ctx = this.canvas.getContext("2d");
          this.fireworks = [];
          this.resize();
          window.addEventListener("resize", this.resize.bind(this));

          // ç›‘å¬é’¢ç´äº‹ä»¶è§¦å‘çƒŸèŠ±
          document.querySelectorAll(".key").forEach((key) => {
            key.addEventListener("mousedown", () => {
              if (Math.random() > 0.7) {
                // 30%æ¦‚ç‡è§¦å‘
                const rect = key.getBoundingClientRect();
                this.launch(rect.left + rect.width / 2);
              }
            });
          });
        }

        resize() {
          this.canvas.width = window.innerWidth;
          this.canvas.height = window.innerHeight;
        }

        launch(x) {
          this.fireworks.push(new Firework(x));
        }

        animate() {
          this.ctx.fillStyle = "rgba(255, 255, 255, 0.01)";
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

          this.fireworks = this.fireworks.filter((firework) => {
            firework.update();
            return !firework.exploded || firework.particles.length > 0;
          });

          this.fireworks.forEach((firework) => firework.draw(this.ctx));
          requestAnimationFrame(this.animate.bind(this));
        }
      }

      // é”®ç›˜äº‹ä»¶ç›‘å¬
      document.addEventListener("keydown", (event) => {
        const key = event.key.toLowerCase();
        if (keyMap[key]) {
          const { note, octaveOffset } = keyMap[key];
          const effectiveOctave = baseOctave + octaveOffset;
          playNote(note, effectiveOctave);
          const keyElement = document.querySelector(`.key[data-key="${key}"]`);
          if (keyElement) {
            keyElement.classList.add("active");
            showFloatingNote(note, effectiveOctave, keyElement);
            setTimeout(() => {
              keyElement.classList.remove("active");
            }, 200);
          }
        }
      });

      // é¼ æ ‡ç‚¹å‡»äº‹ä»¶
      document.querySelectorAll(".key").forEach((keyEl) => {
        keyEl.addEventListener("click", () => {
          const key = keyEl.getAttribute("data-key");
          if (keyMap[key]) {
            const { note, octaveOffset } = keyMap[key];
            const effectiveOctave = baseOctave + octaveOffset;
            playNote(note, effectiveOctave);
            keyEl.classList.add("active");
            showFloatingNote(note, effectiveOctave, keyEl);
            setTimeout(() => {
              keyEl.classList.remove("active");
            }, 200);
          }
        });
      });

      // æ§åˆ¶é¢æ¿æŒ‰é’®
      document.getElementById("octave-up").addEventListener("click", () => {
        baseOctave++;
        updateDisplay();
      });
      document.getElementById("octave-down").addEventListener("click", () => {
        baseOctave--;
        updateDisplay();
      });
      document.getElementById("transpose-up").addEventListener("click", () => {
        transpose++;
        updateDisplay();
      });
      document
        .getElementById("transpose-down")
        .addEventListener("click", () => {
          transpose--;
          updateDisplay();
        });

      updateDisplay();
      // åˆå§‹åŒ–çƒŸèŠ±ç³»ç»Ÿ
      const fireworks = new FireworksSystem();
      fireworks.animate();
    </script>
  </body>
</html>
