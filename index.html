<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ¹âœ¨ ğ… ğ…Ÿ æ°¸æ’ç´èŠ± ğŸ¼ğŸŒ¸</title>
    <style>
      /* å¼•å…¥è½»é‡çº§Googleå­—ä½“ */
      @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap');
      :root {
        --theme-color: rgb(233 193 35 / 29%);
        --theme-gradient: linear-gradient(45deg, #ff69b4, #ff3366);
      }

      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 0;
        overflow: hidden;
      }

      h1 {
        margin-bottom: 10px;
      }

      .controls {
        position: relative;
        z-index: 2;
        margin: 20px auto;
        opacity: 0.8;
      }

      .controls > div:first-of-type {
        margin-bottom: 10px;
      }

      .controls button {
        padding: 8px 12px;
        margin: 0 5px;
        font-size: 14px;
        border: 2px solid var(--theme-color);
        border-radius: 20px;
        box-sizing: border-box;

        background: linear-gradient(to right, #ff8805,  #d9b352);
        background-clip: text;
        color: transparent;
      }

      .controls #current-octave,
      .controls #current-transpose {
        background: linear-gradient(to right, #ff8805,  #d9b352);
        background-clip: text;
        color: transparent;
        margin: 0 5px;
      }

      .piano-container {
        position: relative;
        width: 100%;
        max-width: 480px;
        height: 200px;
        margin: 0 auto;
        z-index: 2; /* é«˜äºCanvas */

        isolation: isolate; /* åˆ›å»ºæ–°å±‚å ä¸Šä¸‹æ–‡ */
        background-attachment: fixed;
        mix-blend-mode: screen; /* é‡‡ç”¨å±å¹•æ··åˆæ¨¡å¼ */

        /* å·®å€¼é®ç½©å®ç° */
        mask-image: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 0.6) 20%,
          rgba(0, 0, 0, 0.3) 80%
        );
        backdrop-filter: brightness(1.1) contrast(0.98) hue-rotate(-5deg);
      }

      .piano {
        display: flex;
        position: relative;
        width: 100%;
        height: 200px;
      }

      .key {
        border: 1px solid #000;
        cursor: pointer;
        user-select: none;

        /* åŸºç¡€åŠé€æ˜æè´¨ */
        background: radial-gradient(
            circle at 75% 25%,
            rgba(255, 255, 255, 0.4) 0%,
            rgba(255, 255, 255, 0.1) 100%
          ),
          linear-gradient(
            145deg,
            rgba(255, 182, 193, 0.85) 30%,
            rgba(255, 105, 180, 0.7) 70%
          );

        /* å¾®å…‰æ™•æº¢å‡ºæ§åˆ¶ */
        filter: drop-shadow(0 2px 4px rgba(255, 105, 180, 0.2))
          url(#spill-suppressor); /* SVGæ»¤é•œæ§åˆ¶è‰²æº¢ */
      }

      /* ç™½é”®è‡ªé€‚åº”å¸ƒå±€ */
      .key.white {
        width: calc(100% / 8); /* 8ä¸ªç™½é”®å‡åˆ†å®½åº¦ */
        height: 200px;
        background: #fff;
        z-index: 1;
        color: #333;
      }

      /* é»‘é”®æ ·å¼ */
      .key.black {
        position: absolute;
        width: 28px; /* æ‰‹æœºç«¯é€‚å½“ç¼©å°é»‘é”®å®½åº¦ */
        height: 120px;
        background: #000;
        z-index: 2;
        color: #fff;
      }

      /* é»‘é”®å®šä½ï¼ˆåŸºäºç™½é”®å®½åº¦è®¡ç®—ï¼‰ */
      .key.black[data-key='w'] {
        left: calc(100% / 8 * 0.7);
      } /* W */
      .key.black[data-key='e'] {
        left: calc(100% / 8 * 1.7);
      } /* E */
      .key.black[data-key='t'] {
        left: calc(100% / 8 * 3.7);
      } /* T */
      .key.black[data-key='y'] {
        left: calc(100% / 8 * 4.7);
      } /* Y */
      .key.black[data-key='u'] {
        left: calc(100% / 8 * 5.7);
      } /* U */

      .key.active {
        /* æ¿€æ´»æ€é€æ˜åº¦å˜åŒ– */
        background-color: rgba(255, 182, 193, 0.6);
        backdrop-filter: brightness(1.2) saturate(1.5);
      }

      /* ä¹è°±å®¹å™¨æ ·å¼ */
      .notation-section {
        position: relative;
        z-index: 2;
        margin: 1rem auto;
        max-width: 480px;
        padding: 0 1rem;
      }

      .notation-title {
        font-size: 1.1rem;
        background: linear-gradient(to right, #ff8805,  #d9b352);
        background-clip: text;
        color: transparent;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: opacity 0.3s;
        opacity: 0.8;
        
      }

      .notation-title:hover {
        opacity: 0.8;
      }

      .notation-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
        font-size: 0.9rem;
      }

      .notation-item {
        border: 1px solid rgb(233 193 35 / 45%);
        border-radius: 12px;
        padding: 0.4rem 0.8rem;
        backdrop-filter: blur(2px);
        transition: all 0.3s;
        background: linear-gradient(to right, #ff8805,  #d9b352);
        background-clip: text;
        color: transparent;
      }

      /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
      @media (max-width: 480px) {
        .notation-item {
          font-size: 0.8rem;
          padding: 0.3rem 0.6rem;
          border-radius: 8px;
        }
      }

      /* åŠ¨æ€æŠ˜å æ•ˆæœ */
      .notation-list.collapsed {
        mask-image: linear-gradient(
          to bottom,
          rgba(0, 0, 0, 1) 60%,
          rgba(0, 0, 0, 0.6) 100%
        );
      }

      /* æŒ‰é”®é«˜äº®æç¤º */
      [data-keys]:hover::after {
        content: attr(data-keys);
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
      }

      #fireworks-canvas {
        position: fixed;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 1;
      }

      /* æ–‡å­—å®¹å™¨å®šä½ */
      .starry-poem {
        position: fixed;
        z-index: 2; /* ç¡®ä¿åœ¨çƒŸèŠ±ä¹‹ä¸‹ */
        bottom: 10%;
        left: 50%;
        transform: translate(-50%, 0%);
        width: 80vw;
        max-width: 600px;
        text-align: center;
        pointer-events: none;
        mix-blend-mode: normal;
      }

      /* æ–‡å­—æ¸å˜ä¸åŠ¨ç”» */
      .poem-text {
        /* UCæµè§ˆå™¨ä¸“ç”¨å­—ä½“æ ˆ */
        font-family: 'STKaiti', /* åæ–‡æ¥·ä½“ï¼ˆiOS/éƒ¨åˆ†å®‰å“ï¼‰ */ 'KaiTi',
          /* Windowsç³»ç»Ÿæ¥·ä½“ */ 'Noto Serif CJK SC',
          /* Google Notoå­—ä½“ */ 'DFKai-SB',
          /* ååº·æ¥·ä½“ï¼ˆéƒ¨åˆ†å®‰å“è®¾å¤‡ï¼‰ */ 'BabelStone Han',
          /* å¤‡ç”¨ä¹¦æ³•å­—ä½“ */ serif; /* é€šç”¨è¡¬çº¿å­—ä½“ */

        /* å¢å¼ºæ¥·ä½“ç‰¹å¾ */
        font-style: italic;

        /* åŠ å¤§æ–‡å­—é—´è· */
        letter-spacing: 1px;
        line-height: 2;

        background: linear-gradient(to right, #ff8805,  #d9b352);
        background-clip: text;
        color: transparent;

        font-size: clamp(24px, 2.5vw, 28px);
        line-height: 1.8;
        opacity: 0.8;
        text-shadow: 0 0 8px rgba(255, 182, 193, 0.2),
          0 0 15px rgba(218, 112, 214, 0.1);
        /* animation: poemGlow 6s ease-in-out infinite; */
      }

      /* æ˜Ÿå…‰å‘¼å¸æ•ˆæœ */
      @keyframes poemGlow {
        0%,
        100% {
          opacity: 0.7;
          filter: blur(1px);
        }
        50% {
          opacity: 0.9;
          filter: blur(0.5px);
        }
      }

      /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
      @media (max-width: 768px) {
        .starry-poem {
          transform: translate(-50%, 0%);
        }
        .poem-text {
          font-size: 24px;
          line-height: 1.6;
        }
      }
    </style>
  </head>
  <body>
    <div class="controls">
      <div>
        <button id="octave-down">å…«åº¦ -1</button>
        <button id="octave-up">å…«åº¦ +1</button>
        <span id="current-octave">å½“å‰å…«åº¦: 4</span>
      </div>
      <div>
        <button id="transpose-down">è½¬è°ƒ -1</button>
        <button id="transpose-up">è½¬è°ƒ +1</button>
        <span id="current-transpose">å½“å‰è½¬è°ƒ: 0</span>
      </div>
    </div>

    <div class="piano-container">
      <div class="piano">
        <!-- ç™½é”® -->
        <div class="key white" data-key="a">a</div>
        <div class="key white" data-key="s">s</div>
        <div class="key white" data-key="d">d</div>
        <div class="key white" data-key="f">f</div>
        <div class="key white" data-key="g">g</div>
        <div class="key white" data-key="h">h</div>
        <div class="key white" data-key="j">j</div>
        <div class="key white" data-key="k">k</div>

        <!-- é»‘é”® -->
        <div class="key black" data-key="w">w</div>
        <div class="key black" data-key="e">e</div>
        <div class="key black" data-key="t">t</div>
        <div class="key black" data-key="y">y</div>
        <div class="key black" data-key="u">u</div>
      </div>
    </div>

    <!-- æµ®åŠ¨éŸ³ç¬¦æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="notes-container"></div>

    <div class="notation-section">
      <h2 class="notation-title" onclick="toggleNotation()">
        ã€Šæ¬¢ä¹é¢‚ã€‹æ¼”å¥æç¤º â–¼
      </h2>
      <ul class="notation-list collapsed">
        <li class="notation-item" data-keys="d, d, f, g">1: d, d, f, g</li>
        <li class="notation-item" data-keys="g, f, d, s">2: g, f, d, s</li>
        <li class="notation-item" data-keys="a, a, s, d">3: a, a, s, d</li>
        <li class="notation-item" data-keys="d, s, s">4: d, s, s â€“</li>
        <li class="notation-item" data-keys="d, d, f, g">5: d, d, f, g</li>
        <li class="notation-item" data-keys="g, f, d, s">6: g, f, d, s</li>
        <li class="notation-item" data-keys="a, a, s, d">7: a, a, s, d</li>
        <li class="notation-item" data-keys="s, a, a">8: s, a, a â€“</li>
      </ul>
    </div>

    <div class="starry-poem">
      <div class="poem-text">
        æˆ‘ä¸ç¥ä½ å‹‡æ•¢ã€æ…·æ…¨<br />
        æˆ‘ç¥ä½ é¼æ²¸<br />
        ç¥ä½ äººç”Ÿæµ·æµ·<br />
        å°½å…´ã€å¼€æ€€ï¼
      </div>
    </div>

    <!-- åœ¨bodyæœ«å°¾æ·»åŠ canvaså…ƒç´  -->
    <canvas id="fireworks-canvas"></canvas>

    <script>
      // å®šä¹‰å„è‡ªç„¶éŸ³ç›¸å¯¹äºCçš„åŠéŸ³åç§»
      const noteOffsets = {
        C: 0,
        'C#': 1,
        D: 2,
        'D#': 3,
        E: 4,
        F: 5,
        'F#': 6,
        G: 7,
        'G#': 8,
        A: 9,
        'A#': 10,
        B: 11,
      };

      // é”®ç›˜æ˜ å°„ï¼Œæ¯ä¸ªé”®æ˜ å°„åˆ°éŸ³ç¬¦å’Œç›¸å¯¹äºåŸºå‡†å…«åº¦çš„åç§»
      const keyMap = {
        a: { note: 'C', octaveOffset: 0 },
        w: { note: 'C#', octaveOffset: 0 },
        s: { note: 'D', octaveOffset: 0 },
        e: { note: 'D#', octaveOffset: 0 },
        d: { note: 'E', octaveOffset: 0 },
        f: { note: 'F', octaveOffset: 0 },
        t: { note: 'F#', octaveOffset: 0 },
        g: { note: 'G', octaveOffset: 0 },
        y: { note: 'G#', octaveOffset: 0 },
        h: { note: 'A', octaveOffset: 0 },
        u: { note: 'A#', octaveOffset: 0 },
        j: { note: 'B', octaveOffset: 0 },
        k: { note: 'C', octaveOffset: 1 }, // â€œkâ€é”®ä»£è¡¨é«˜ä¸€ä¸ªå…«åº¦çš„C
      };

      let baseOctave = 4;
      let transpose = 0;

      function updateDisplay() {
        document.getElementById(
          'current-octave'
        ).textContent = `å½“å‰å…«åº¦: ${baseOctave}`;
        document.getElementById(
          'current-transpose'
        ).textContent = `å½“å‰è½¬è°ƒ: ${transpose}`;
      }

      // è®¡ç®—éŸ³ç¬¦é¢‘ç‡ï¼šf = 440 Ã— 2^((effectiveSemitone)/12)
      function getFrequency(note, octave) {
        const semitoneDiff =
          (octave - 4) * 12 +
          (noteOffsets[note] - noteOffsets['A']) +
          transpose;
        return 440 * Math.pow(2, semitoneDiff / 12);
      }

      // æ’­æ”¾éŸ³ç¬¦
      const audioContext = new (window.AudioContext ||
        window.webkitAudioContext)();
      let oscillator;

      function playNote(note, octave) {
        oscillator?.stop();
        const freq = getFrequency(note, octave);
        oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        const safeFreq = Math.max(
          0.0001,
          Math.min(96000, Number.isFinite(freq) ? freq : 440)
        ); // å¼ºåˆ¶é™å®šæœ‰æ•ˆèŒƒå›´
        oscillator.frequency.value = Math.fround(safeFreq); // è§£å†³ç²¾åº¦é—®é¢˜
        oscillator.type = 'sine';

        const now = audioContext.currentTime;
        gainNode.gain.cancelScheduledValues(now);
        // åœ¨å½“å‰æ—¶é—´ç«‹å³å°†å¢ç›Šå€¼è®¾ä¸º0ï¼Œå³éŸ³é‡ä¸º0
        gainNode.gain.setValueAtTime(0, now);
        // åœ¨0.1ç§’å†…ä½¿å¢ç›Šå€¼çº¿æ€§ä¸Šå‡åˆ°1
        gainNode.gain.linearRampToValueAtTime(1, now + 0.1);
        // now+0.5ç§’åï¼Œå°†å¢ç›Šè®¾ç½®ä¸º1
        gainNode.gain.setValueAtTime(1, now + 0.5);
        // åœ¨ now+0.45 åˆ° now+0.7 ä¹‹é—´ï¼Œä½¿å¢ç›Šå€¼çº¿æ€§ä¸‹é™åˆ°0
        gainNode.gain.linearRampToValueAtTime(0, now + 0.7);

        oscillator.start(now);
        oscillator.stop(now + 0.7);
      }

      // çƒŸèŠ±ç³»ç»Ÿæ ¸å¿ƒå®ç°
      class Firework {
        constructor({ startX, hue, targetY, speed }) {
          this.x = startX;
          this.y = window.innerHeight + 50; // ä»å±å¹•åº•éƒ¨å¤–å¼€å§‹
          this.targetY = targetY || window.innerHeight * 0.7; // ç²¾ç¡®åˆ°å±å¹•å¯è§†åŒºåŸŸçš„ä¸€å®šé«˜åº¦ï¼ˆéæ–‡æ¡£æ€»é«˜åº¦ï¼‰
          this.speed = speed || 18; // æå‡åˆå§‹é€Ÿåº¦
          this.radius = 5; // å¢å¤§ä¸Šå‡å…‰çƒå°ºå¯¸
          this.hue = hue || Math.random() * 50 + 280; // ç²‰è‰²ç³»
          this.particles = [];
          this.exploded = false;
        }

        update() {
          if (!this.exploded) {
            this.y -= this.speed * 0.98; // æ·»åŠ é€Ÿåº¦è¡°å‡

            // åŒé‡é«˜åº¦éªŒè¯ï¼ˆé˜²æ­¢æº¢å‡ºå±å¹•é¡¶éƒ¨ï¼‰
            const isOverTarget = this.y <= this.targetY;
            const isOverTop = this.y <= 0;
            if (isOverTarget || isOverTop) {
              this.explode();
            }
          }

          this.particles.forEach((p) => p.update());
          this.particles = this.particles
            .filter((p) => p.opacity > 0.1)
            .slice(0, 300); // æ€§èƒ½ä¼˜åŒ–
        }

        explode() {
          this.exploded = true;
          for (let i = 0; i < 100; i++) {
            this.particles.push(
              new Particle(this.x, this.y, Math.PI * 2 * (i / 100), this.hue)
            );
          }
        }

        draw(ctx) {
          // ç»˜åˆ¶ä¸Šå‡è½¨è¿¹
          if (!this.exploded) {
            // åˆ›å»ºè½¨è¿¹æ¸å˜
            const gradient = ctx.createLinearGradient(
              this.x,
              window.innerHeight,
              this.x,
              this.y
            );
            gradient.addColorStop(0, `hsla(${this.hue}, 80%, 60%, 0.7)`);
            gradient.addColorStop(1, `hsla(${this.hue}, 80%, 70%, 0.3)`);

            // ç»˜åˆ¶åŠ å®½è½¨è¿¹ï¼ˆåŠ¨æ€çº¿å®½ï¼‰
            ctx.beginPath();
            ctx.moveTo(this.x, window.innerHeight);
            ctx.lineTo(this.x, this.y);
            ctx.lineWidth = Math.max(8 * (1 - this.y / this.targetY), 4); // åŠ¨æ€å®½åº¦è®¡ç®—
            ctx.strokeStyle = gradient;
            ctx.stroke();

            // ç»˜åˆ¶å‘å…‰æ ¸å¿ƒ
            ctx.beginPath();
            ctx.arc(this.x, this.y, 6, 0, Math.PI * 2);
            ctx.fillStyle = `hsla(60, 80%, 70%, 0.9)`;
            ctx.fill();
          }

          // ç»˜åˆ¶çˆ†ç‚¸ç²’å­
          this.particles.forEach((p) => {
            p.draw(ctx);
            // ç²’å­æ‹–å°¾å…‰æ™•
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size * 2, 0, Math.PI * 2);
            ctx.fillStyle = `hsla(${p.hue}, 60%, 50%, ${p.opacity * 0.3})`;
            ctx.fill();
          });
        }
      }

      class Particle {
        constructor(x, y, angle, hue) {
          this.x = x;
          this.y = y;
          this.angle = angle + (Math.random() - 0.5) * 1.2;
          this.velocity = Math.random() * 8 + 5;
          this.gravity = 0.5; // åŠ å¤§é‡åŠ›
          this.friction = 0.91; // å‡å°‘ç©ºæ°”é˜»åŠ›
          this.hue = hue + Math.random() * 60 - 20; // è‰²ç›¸æ³¢åŠ¨
          this.size = Math.random() * 3 + 1;
          this.opacity = 1;
        }

        update() {
          this.velocity *= this.friction;
          this.x += Math.cos(this.angle) * this.velocity;
          this.y += Math.sin(this.angle) * this.velocity + this.gravity;
          this.opacity -= 0.013; // å‡ç¼“æ¶ˆå¤±é€Ÿåº¦
        }

        draw(ctx) {
          // æ·»åŠ å‘å…‰æ•ˆæœ
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size * 2, 0, Math.PI * 2);
          ctx.fillStyle = `hsla(${this.hue}, 80%, 50%, ${this.opacity * 0.3})`;
          ctx.fill();

          // æ ¸å¿ƒç²’å­
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fillStyle = `hsla(${this.hue}, 80%, 70%, ${this.opacity})`;
          ctx.fill();
        }
      }

      // çƒŸèŠ±ç³»ç»Ÿæ§åˆ¶å™¨
      class FireworksSystem {
        constructor() {
          this.fireworks = []; // åˆå§‹åŒ–çƒŸèŠ±ç²’å­
          this.stars = []; // åˆå§‹åŒ–æ˜Ÿæ˜Ÿæ•°ç»„
          // é¢‘ç‡æ˜ å°„å‚æ•°
          this.minFreq = 130.81; // C3 (æœ€ä½éŸ³)
          this.maxFreq = 2093.0; // C7 (æœ€é«˜éŸ³)
          this.heightRange = [0.5, 0.9]; // å±å¹•é«˜åº¦æ¯”ä¾‹èŒƒå›´ [æœ€é«˜éŸ³ä½ç½®, æœ€ä½éŸ³ä½ç½®]

          this.canvas = document.getElementById('fireworks-canvas');
          this.ctx = this.canvas.getContext('2d');
          this.resize();
          window.addEventListener('resize', () => this.resize());

          // åœ¨ç´é”®äº‹ä»¶ç»‘å®šä¸­ä¼ é€’é¢‘ç‡
          document.querySelectorAll('.key').forEach((keyElement) => {
            keyElement.addEventListener('mousedown', () => {
              const rect = keyElement.getBoundingClientRect();
              const key = keyElement.getAttribute('data-key');
              const { note, octaveOffset } = keyMap[key];
              const effectiveOctave = baseOctave + octaveOffset;
              const frequency = getFrequency(note, effectiveOctave);
              fireworks.launch(rect.left + rect.width / 2, frequency);
            });
          });

          this.animate();
        }

        // åˆå§‹åŒ–æ˜Ÿç©º
        initStars(count) {
          for (let i = 0; i < count; i++) {
            this.stars.push({
              x: Math.random() * this.canvas.width,
              y: Math.random() * this.canvas.height,
              size: Math.random() * 1.5 + 0.5,
              alpha: Math.random() * 0.5 + 0.5,
              speed: Math.random() * 0.02 + 0.01,
            });
          }
        }

        // ç»˜åˆ¶æ˜Ÿç©ºèƒŒæ™¯
        drawBackground() {
          // åˆ›å»ºæ·±ç©ºæ¸å˜èƒŒæ™¯
          const gradient = this.ctx.createRadialGradient(
            this.canvas.width / 2,
            this.canvas.height / 2,
            0,
            this.canvas.width / 2,
            this.canvas.height / 2,
            Math.max(this.canvas.width, this.canvas.height)
          );
          gradient.addColorStop(0, '#0a0a2a');
          gradient.addColorStop(1, '#000000');

          this.ctx.fillStyle = gradient;
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

          // ç»˜åˆ¶é—ªçƒæ˜Ÿæ˜Ÿ
          this.stars.forEach((star) => {
            star.alpha += star.speed;
            if (star.alpha > 1 || star.alpha < 0.3) star.speed *= -1;

            this.ctx.beginPath();
            this.ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
            this.ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
            this.ctx.fill();
          });
        }

        resize() {
          this.canvas.width = window.innerWidth;
          this.canvas.height = window.innerHeight;
          this.initStars(200); // é‡ç½®æ˜Ÿæ˜Ÿä½ç½®
        }

        launch(x, frequency) {
          // æ ‡å‡†åŒ–é¢‘ç‡åˆ°é«˜åº¦æ¯”ä¾‹
          const normalized =
            (Math.log2(frequency) - Math.log2(this.minFreq)) /
            (Math.log2(this.maxFreq) - Math.log2(this.minFreq));
          const targetYRatio =
            this.heightRange[0] +
            (1 - normalized) * (this.heightRange[1] - this.heightRange[0]);

          const firework = new Firework({
            startX: x,
            hue: Math.random() * 360, // å…¨è‰²åŸŸéšæœº
            targetY: window.innerHeight * targetYRatio, // é¢‘ç‡è¶Šé«˜Yå€¼è¶Šå°ï¼ˆä½ç½®æ›´é«˜ï¼‰
            speed: 18 + normalized * 10, // é«˜é¢‘éŸ³ç¬¦é€Ÿåº¦æ›´å¿«
          });

          this.fireworks.push(firework);
        }

        animate() {
          // å…ˆæ¸…ç©ºç”»å¸ƒ
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

          // å…ˆç»˜åˆ¶æ˜Ÿç©ºèƒŒæ™¯
          this.drawBackground();

          // æ·»åŠ å°¾è¿¹æ•ˆæœ
          this.ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
          this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

          this.fireworks.forEach((firework) => {
            firework.update();
            firework.draw(this.ctx);
          });

          // è‡ªåŠ¨æ¸…ç†
          this.fireworks = this.fireworks.filter(
            (f) => !f.exploded || f.particles.length > 0
          );

          requestAnimationFrame(() => this.animate());
        }
      }

      // ç´é”®ç‚¹å‡»äº‹ä»¶
      document.querySelectorAll('.key').forEach((keyEl) => {
        keyEl.addEventListener('click', () => {
          const key = keyEl.getAttribute('data-key');
          if (keyMap[key]) {
            const { note, octaveOffset } = keyMap[key];
            const effectiveOctave = baseOctave + octaveOffset;
            playNote(note, effectiveOctave);
            keyEl.classList.add('active');
            setTimeout(() => {
              keyEl.classList.remove('active');
            }, 200);
          }
        });
      });

      // é”®ç›˜äº‹ä»¶ç›‘å¬
      document.addEventListener('keydown', (event) => {
        const key = event.key.toLowerCase();
        if (keyMap[key]) {
          const { note, octaveOffset } = keyMap[key];
          const effectiveOctave = baseOctave + octaveOffset;
          playNote(note, effectiveOctave);
          const keyElement = document.querySelector(`.key[data-key="${key}"]`);
          if (keyElement) {
            keyElement.classList.add('active');
            setTimeout(() => {
              keyElement.classList.remove('active');
            }, 200);
          }
        }
      });

      // æ§åˆ¶é¢æ¿æŒ‰é’®
      document.getElementById('octave-up').addEventListener('click', () => {
        baseOctave++;
        updateDisplay();
      });
      document.getElementById('octave-down').addEventListener('click', () => {
        baseOctave--;
        updateDisplay();
      });
      document.getElementById('transpose-up').addEventListener('click', () => {
        transpose++;
        updateDisplay();
      });
      document
        .getElementById('transpose-down')
        .addEventListener('click', () => {
          transpose--;
          updateDisplay();
        });

      // åˆå§‹åŒ–éŸ³è°ƒæ˜¾ç¤º
      updateDisplay();

      // åˆå§‹åŒ–çƒŸèŠ±ç³»ç»Ÿ
      const fireworks = new FireworksSystem();
    </script>
  </body>
</html>
